<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Moscow Chrono ‚Äî Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
tailwind.config={darkMode:'class',theme:{extend:{colors:{brand:{50:'#fffbeb',100:'#fef3c7',200:'#fde68a',300:'#fcd34d',400:'#fbbf24',500:'#f59e0b',600:'#d97706',700:'#b45309',800:'#92400e',900:'#78350f'}}}}}
</script>
<style>
[x-cloak]{display:none!important}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#1e293b}
::-webkit-scrollbar-thumb{background:#475569;border-radius:3px}
.toast-anim{animation:slideIn .3s ease}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.leaflet-container{background:#1e293b!important}
</style>
</head>
<body class="bg-slate-900 text-white min-h-screen" x-data="app()" x-cloak>

<!-- Toasts -->
<div class="fixed top-4 right-4 z-50 flex flex-col gap-2">
  <template x-for="t in toasts" :key="t.id">
    <div class="toast-anim px-4 py-3 rounded-lg shadow-lg text-sm font-medium max-w-sm"
         :class="t.type==='error'?'bg-red-600':'bg-emerald-600'"
         x-text="t.msg"
         x-init="setTimeout(()=>toasts=toasts.filter(x=>x.id!==t.id),3000)"></div>
  </template>
</div>

<!-- Confirm Dialog -->
<div x-show="confirmDialog.show" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60" x-transition>
  <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 max-w-sm w-full mx-4">
    <h3 class="text-lg font-bold mb-2" x-text="confirmDialog.title"></h3>
    <p class="text-slate-400 text-sm mb-6" x-text="confirmDialog.msg"></p>
    <div class="flex justify-end gap-3">
      <button @click="confirmDialog.show=false" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">–û—Ç–º–µ–Ω–∞</button>
      <button @click="confirmDialog.onOk();confirmDialog.show=false" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- LOGIN -->
<template x-if="!token">
<div class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-slate-800 border border-slate-700 rounded-xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
      <div class="w-16 h-16 bg-brand-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-brand-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
      </div>
      <h1 class="text-2xl font-bold">Moscow Chrono</h1>
      <p class="text-slate-400 text-sm mt-1">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
    </div>
    <form @submit.prevent="doLogin()">
      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-300 mb-1">–õ–æ–≥–∏–Ω</label>
        <input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="loginForm.username" required>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-300 mb-1">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="loginForm.password" required>
      </div>
      <button type="submit" class="w-full py-2.5 rounded-lg bg-brand-500 hover:bg-brand-600 text-black font-medium text-sm" :disabled="loading">–í–æ–π—Ç–∏</button>
      <p x-show="loginError" class="text-red-400 text-sm mt-3 text-center" x-text="loginError"></p>
    </form>
  </div>
</div>
</template>

<!-- MAIN LAYOUT -->
<template x-if="token">
<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-60 bg-slate-800 border-r border-slate-700 flex flex-col flex-shrink-0">
    <div class="p-4 border-b border-slate-700 flex items-center gap-3">
      <div class="w-9 h-9 bg-brand-500/20 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-brand-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
      </div>
      <div><div class="font-bold text-sm">Moscow Chrono</div><div class="text-xs text-slate-400">Admin</div></div>
    </div>
    <nav class="flex-1 p-2 space-y-0.5 overflow-y-auto text-sm">
      <template x-for="item in sidebarItems" :key="item.id">
        <div @click="navigate(item.id)" class="flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors"
             :class="page===item.id?'bg-brand-500/20 text-brand-400':'text-slate-300 hover:bg-slate-700/50 hover:text-white'">
          <span x-html="item.icon" class="w-5 h-5 flex-shrink-0"></span>
          <span x-text="item.label"></span>
        </div>
      </template>
    </nav>
    <div class="p-3 border-t border-slate-700">
      <div class="flex items-center gap-3 px-2 py-1.5">
        <div class="w-8 h-8 bg-brand-500/20 rounded-full flex items-center justify-center text-brand-400 text-sm font-bold" x-text="(me?.username||'A')[0].toUpperCase()"></div>
        <div class="flex-1 min-w-0"><div class="text-sm font-medium truncate" x-text="me?.username||''"></div></div>
        <button @click="logout()" class="text-slate-400 hover:text-red-400" title="–í—ã–π—Ç–∏">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- Content -->
  <main class="flex-1 overflow-y-auto p-6">
    <div class="max-w-7xl mx-auto">

    <!-- DASHBOARD -->
    <div x-show="page==='dashboard'">
      <h1 class="text-2xl font-bold mb-6">–î–∞—à–±–æ—Ä–¥</h1>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <template x-for="s in stats" :key="s.label">
          <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
            <div class="text-slate-400 text-sm" x-text="s.label"></div>
            <div class="text-3xl font-bold mt-1" :class="s.color" x-text="s.value"></div>
          </div>
        </template>
      </div>
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
          <h3 class="font-semibold mb-4">–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ XP</h3>
          <div class="space-y-3">
            <template x-for="(u,i) in leaderboard" :key="u.id">
              <div class="flex items-center gap-3">
                <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" :class="i<3?'bg-brand-500 text-black':'bg-slate-700 text-slate-300'" x-text="i+1"></span>
                <span class="flex-1 text-sm" x-text="u.display_name||u.username"></span>
                <span class="text-brand-400 font-medium text-sm" x-text="Math.round(u.xp)+' XP'"></span>
                <span class="text-slate-500 text-xs" x-text="'Lv.'+u.level"></span>
              </div>
            </template>
            <div x-show="leaderboard.length===0" class="text-slate-500 text-sm">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
          </div>
        </div>
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
          <h3 class="font-semibold mb-4">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          <div class="grid grid-cols-2 gap-3">
            <button @click="page='pois';loadPois();showPoiForm=true;resetPoiForm()" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-3 text-sm text-left">‚ûï –ù–æ–≤–∞—è —Ç–æ—á–∫–∞</button>
            <button @click="page='routes';loadRoutes();showRouteForm=true;resetRouteForm()" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-3 text-sm text-left">üó∫Ô∏è –ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç</button>
            <button @click="page='quizzes';loadQuizzes();showQuizForm=true;resetQuizForm()" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-3 text-sm text-left">‚ùì –ù–æ–≤—ã–π –∫–≤–∏–∑</button>
            <button @click="page='users';loadUsers()" class="bg-slate-700 hover:bg-slate-600 rounded-lg p-3 text-sm text-left">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
          </div>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <div x-show="page==='users'">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        <span class="text-slate-400 text-sm" x-text="users.length+' –≤—Å–µ–≥–æ'"></span>
      </div>
      <div class="mb-4">
        <input class="w-full max-w-md bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." x-model="userSearch">
      </div>
      <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-900/50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">ID</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Email</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–£—Ä–æ–≤–µ–Ω—å</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">XP</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–†–æ–ª—å</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Telegram</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
              <template x-for="u in filteredUsers" :key="u.id">
                <tr class="hover:bg-slate-700/30">
                  <td class="px-4 py-3 text-sm text-slate-400" x-text="u.id"></td>
                  <td class="px-4 py-3">
                    <div class="text-sm font-medium" x-text="u.display_name||u.username"></div>
                    <div class="text-xs text-slate-500" x-text="'@'+u.username" x-show="u.display_name"></div>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-300" x-text="u.email||'‚Äî'"></td>
                  <td class="px-4 py-3 text-sm"><span class="bg-brand-500/20 text-brand-400 px-2 py-0.5 rounded text-xs font-medium" x-text="'Lv.'+u.level"></span></td>
                  <td class="px-4 py-3 text-sm text-brand-400 font-medium" x-text="Math.round(u.xp)"></td>
                  <td class="px-4 py-3 text-sm">
                    <span x-show="u.is_superuser" class="bg-red-500/20 text-red-400 px-2 py-0.5 rounded text-xs font-medium">Admin</span>
                    <span x-show="!u.is_superuser" class="bg-slate-600 text-slate-300 px-2 py-0.5 rounded text-xs font-medium">User</span>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-400" x-text="u.telegram_id?('ID: '+u.telegram_id):'‚Äî'"></td>
                  <td class="px-4 py-3">
                    <button x-show="!u.is_superuser" @click="confirmDel('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?','–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '+u.username+' –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω.',()=>deleteUser(u.id))" class="text-red-400 hover:text-red-300 text-sm">–£–¥–∞–ª–∏—Ç—å</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- POIs -->
    <div x-show="page==='pois'">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">–¢–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞</h1>
        <button @click="showPoiForm=true;resetPoiForm()" class="px-4 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>

      <!-- POI List -->
      <div x-show="!showPoiForm" class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-900/50"><tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">ID</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ê–¥—Ä–µ—Å</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–§–æ—Ç–æ</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–°—Ç–∞—Ç—å—è</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr></thead>
            <tbody class="divide-y divide-slate-700">
              <template x-for="p in pois" :key="p.id">
                <tr class="hover:bg-slate-700/30">
                  <td class="px-4 py-3 text-sm text-slate-400" x-text="p.id"></td>
                  <td class="px-4 py-3 text-sm font-medium" x-text="p.title"></td>
                  <td class="px-4 py-3 text-sm text-slate-400 max-w-[200px] truncate" x-text="p.address||'‚Äî'"></td>
                  <td class="px-4 py-3 text-sm text-slate-400 font-mono text-xs" x-text="p.latitude.toFixed(4)+', '+p.longitude.toFixed(4)"></td>
                  <td class="px-4 py-3 text-sm text-slate-400">
                    <div class="flex flex-col gap-0.5">
                      <span x-show="(p.photos||[]).length>0" class="text-brand-400 text-xs" x-text="(p.photos||[]).length+' –ø–æ –≥–æ–¥–∞–º'"></span>
                      <span x-show="(p.historic_images||[]).length+(p.modern_images||[]).length>0" class="text-xs" x-text="((p.historic_images||[]).length+(p.modern_images||[]).length)+' legacy'"></span>
                      <span x-show="(p.photos||[]).length===0&&(p.historic_images||[]).length+(p.modern_images||[]).length===0" class="text-xs">‚Äî</span>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    <span x-show="p.full_article" class="text-emerald-400 text-xs">‚úÖ –ï—Å—Ç—å</span>
                    <span x-show="!p.full_article" class="text-slate-500 text-xs">‚Äî</span>
                  </td>
                  <td class="px-4 py-3 flex gap-2">
                    <button @click="editPoi(p)" class="text-brand-400 hover:text-brand-300 text-sm">–†–µ–¥.</button>
                    <button @click="confirmDel('–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É?',p.title,()=>deletePoi(p.id))" class="text-red-400 hover:text-red-300 text-sm">–£–¥–∞–ª.</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="pois.length===0" class="p-8 text-center text-slate-500">–ù–µ—Ç —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–∞</div>
      </div>

      <!-- POI Form -->
      <div x-show="showPoiForm" class="bg-slate-800 border border-slate-700 rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold" x-text="poiForm.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ POI #'+poiForm.id:'–ù–æ–≤–∞—è —Ç–æ—á–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞'"></h2>
          <button @click="showPoiForm=false" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <form @submit.prevent="savePoi()" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.title" required></div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-sm font-medium text-slate-300 mb-1">–®–∏—Ä–æ—Ç–∞ *</label><input type="number" step="any" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model.number="poiForm.latitude" required></div>
              <div><label class="block text-sm font-medium text-slate-300 mb-1">–î–æ–ª–≥–æ—Ç–∞ *</label><input type="number" step="any" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model.number="poiForm.longitude" required></div>
            </div>
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-1">–ê–¥—Ä–µ—Å</label><input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.address" placeholder="–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å, 1"></div>
          <div><label class="block text-sm font-medium text-slate-300 mb-1">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞)</label><textarea class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[80px]" x-model="poiForm.description" placeholder="–ö—Ä–∞—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏"></textarea></div>

          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ç–æ (URL)</label><input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.historic_image_url" placeholder="URL –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª">
              <input type="file" accept="image/*" class="mt-1 text-xs text-slate-400" @change="uploadFile($event, v=>poiForm.historic_image_url=v)">
              <img x-show="poiForm.historic_image_url" :src="fullUrl(poiForm.historic_image_url)" class="mt-2 h-20 rounded object-cover">
            </div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ (URL)</label><input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.modern_image_url" placeholder="URL –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª">
              <input type="file" accept="image/*" class="mt-1 text-xs text-slate-400" @change="uploadFile($event, v=>poiForm.modern_image_url=v)">
              <img x-show="poiForm.modern_image_url" :src="fullUrl(poiForm.modern_image_url)" class="mt-2 h-20 rounded object-cover">
            </div>
          </div>

          <!-- Gallery -->
          <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4">
            <h3 class="text-sm font-semibold mb-3">üì∑ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ç–æ (–≥–∞–ª–µ—Ä–µ—è)</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <template x-for="(img,i) in poiForm.historic_images" :key="i">
                <div class="relative w-24 h-18 rounded overflow-hidden border border-slate-600">
                  <img :src="fullUrl(img)" class="w-full h-full object-cover">
                  <button type="button" @click="poiForm.historic_images.splice(i,1)" class="absolute top-0 right-0 bg-red-600 text-white w-5 h-5 text-xs rounded-bl">√ó</button>
                </div>
              </template>
            </div>
            <input type="file" accept="image/*" class="text-xs text-slate-400" @change="uploadFile($event, v=>{poiForm.historic_images.push(v)})">
          </div>
          <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4">
            <h3 class="text-sm font-semibold mb-3">üì∏ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (–≥–∞–ª–µ—Ä–µ—è)</h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <template x-for="(img,i) in poiForm.modern_images" :key="i">
                <div class="relative w-24 h-18 rounded overflow-hidden border border-slate-600">
                  <img :src="fullUrl(img)" class="w-full h-full object-cover">
                  <button type="button" @click="poiForm.modern_images.splice(i,1)" class="absolute top-0 right-0 bg-red-600 text-white w-5 h-5 text-xs rounded-bl">√ó</button>
                </div>
              </template>
            </div>
            <input type="file" accept="image/*" class="text-xs text-slate-400" @change="uploadFile($event, v=>{poiForm.modern_images.push(v)})">
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞ URL</label>
              <input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.historic_panorama_url">
              <input type="file" accept="image/*" class="mt-1 text-xs text-slate-400" @change="uploadFile($event, v=>poiForm.historic_panorama_url=v)">
            </div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞ URL</label>
              <input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="poiForm.modern_panorama_url">
              <input type="file" accept="image/*" class="mt-1 text-xs text-slate-400" @change="uploadFile($event, v=>poiForm.modern_panorama_url=v)">
            </div>
          </div>

          <!-- Year-based Photos -->
          <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold">üìÖ –§–æ—Ç–æ –ø–æ –≥–æ–¥–∞–º</h3>
              <button type="button" @click="poiForm.photos.push({year:new Date().getFullYear(),image_url:'',description:'',source:''})" class="px-3 py-1 bg-brand-500 hover:bg-brand-600 text-black text-xs rounded-lg font-medium">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
            </div>
            <div x-show="poiForm.photos.length===0" class="text-slate-500 text-sm py-4 text-center">–ù–µ—Ç —Ñ–æ—Ç–æ –ø–æ –≥–æ–¥–∞–º. –ù–∞–∂–º–∏—Ç–µ ¬´+ –î–æ–±–∞–≤–∏—Ç—å¬ª —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div>
            <div class="space-y-3">
              <template x-for="(ph,i) in poiForm.photos" :key="i">
                <div class="bg-slate-800 border border-slate-600 rounded-lg p-3">
                  <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                      <img x-show="ph.image_url" :src="fullUrl(ph.image_url)" class="w-20 h-16 rounded object-cover border border-slate-600">
                      <div x-show="!ph.image_url" class="w-20 h-16 rounded bg-slate-700 flex items-center justify-center text-slate-500 text-xs">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                    </div>
                    <div class="flex-1 grid grid-cols-2 gap-2">
                      <div>
                        <label class="text-xs text-slate-400">–ì–æ–¥ *</label>
                        <input type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm" x-model.number="ph.year" min="1800" max="2100">
                      </div>
                      <div>
                        <label class="text-xs text-slate-400">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                        <input class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm" x-model="ph.source" placeholder="–ê–≤—Ç–æ—Ä/–∞—Ä—Ö–∏–≤">
                      </div>
                      <div class="col-span-2">
                        <label class="text-xs text-slate-400">URL —Ñ–æ—Ç–æ *</label>
                        <input class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm" x-model="ph.image_url" placeholder="URL">
                        <input type="file" accept="image/*" class="mt-1 text-xs text-slate-400" @change="uploadFile($event, v=>{ph.image_url=v})">
                      </div>
                      <div class="col-span-2">
                        <label class="text-xs text-slate-400">–ü–æ–¥–ø–∏—Å—å</label>
                        <input class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm" x-model="ph.description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ç–æ">
                      </div>
                    </div>
                    <button type="button" @click="poiForm.photos.splice(i,1)" class="text-red-400 hover:text-red-300 p-1 flex-shrink-0" title="–£–¥–∞–ª–∏—Ç—å">‚úñ</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Full Article -->
          <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4">
            <h3 class="text-sm font-semibold mb-2">üìù –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç—å—è</h3>
            <p class="text-xs text-slate-500 mb-2">–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å—Ç–∞—Ç—å—è –æ–± –æ–±—ä–µ–∫—Ç–µ. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown.</p>
            <textarea class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[200px] font-mono" x-model="poiForm.full_article" placeholder="# –ó–∞–≥–æ–ª–æ–≤–æ–∫

–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏...

## –ò—Å—Ç–æ—Ä–∏—è

–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏..."></textarea>
            <div class="mt-2 flex items-center gap-3">
              <span class="text-xs text-slate-500" x-text="(poiForm.full_article||'').length+' —Å–∏–º–≤–æ–ª–æ–≤'"></span>
              <span x-show="poiForm.full_article" class="text-xs text-emerald-400">‚úÖ –°—Ç–∞—Ç—å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞</span>
            </div>
          </div>

          <div class="flex gap-3 pt-2">
            <button type="submit" class="px-6 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium" :disabled="loading">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" @click="showPoiForm=false" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>


    <!-- ROUTES -->
    <div x-show="page==='routes'">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">–ú–∞—Ä—à—Ä—É—Ç—ã</h1>
        <button @click="showRouteForm=true;resetRouteForm()" class="px-4 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <div x-show="!showRouteForm" class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-900/50"><tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">ID</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">XP</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–¢–æ—á–∫–∏</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–ü—Ä–µ–º–∏—É–º</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr></thead>
        <tbody class="divide-y divide-slate-700">
          <template x-for="r in routes" :key="r.id">
            <tr class="hover:bg-slate-700/30">
              <td class="px-4 py-3 text-sm text-slate-400" x-text="r.id"></td>
              <td class="px-4 py-3 text-sm font-medium" x-text="r.title"></td>
              <td class="px-4 py-3 text-sm"><span class="px-2 py-0.5 rounded text-xs font-medium" :class="{'bg-emerald-500/20 text-emerald-400':r.difficulty==='Easy'||r.difficulty==='easy','bg-yellow-500/20 text-yellow-400':r.difficulty==='Medium'||r.difficulty==='medium','bg-red-500/20 text-red-400':r.difficulty==='Hard'||r.difficulty==='hard'}" x-text="r.difficulty"></span></td>
              <td class="px-4 py-3 text-sm text-brand-400" x-text="r.reward_xp"></td>
              <td class="px-4 py-3 text-sm text-slate-400" x-text="(r.points||[]).length"></td>
              <td class="px-4 py-3 text-sm"><span x-show="r.is_premium" class="text-brand-400">‚≠ê</span><span x-show="!r.is_premium" class="text-slate-500">‚Äî</span></td>
              <td class="px-4 py-3 flex gap-2">
                <button @click="editRoute(r)" class="text-brand-400 hover:text-brand-300 text-sm">–†–µ–¥.</button>
                <button @click="confirmDel('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç?',r.title,()=>deleteRoute(r.id))" class="text-red-400 hover:text-red-300 text-sm">–£–¥–∞–ª.</button>
              </td>
            </tr>
          </template>
        </tbody></table>
        <div x-show="routes.length===0" class="p-8 text-center text-slate-500">–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤</div>
      </div>

      <!-- Route Form -->
      <div x-show="showRouteForm" class="bg-slate-800 border border-slate-700 rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold" x-text="routeForm.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ #'+routeForm.id:'–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç'"></h2>
          <button @click="showRouteForm=false" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <form @submit.prevent="saveRoute()" class="space-y-4">
          <div><label class="block text-sm font-medium text-slate-300 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="routeForm.title" required></div>
          <div><label class="block text-sm font-medium text-slate-300 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[60px]" x-model="routeForm.description"></textarea></div>
          <div class="grid md:grid-cols-3 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
              <select class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="routeForm.difficulty">
                <option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option>
              </select>
            </div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1">XP –ù–∞–≥—Ä–∞–¥–∞</label><input type="number" step="0.1" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model.number="routeForm.reward_xp"></div>
            <div class="flex items-end"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" x-model="routeForm.is_premium" class="rounded"><span class="text-sm text-slate-300">–ü—Ä–µ–º–∏—É–º</span></label></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">–¢–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)</label>
            <div class="flex flex-wrap gap-2 mb-2">
              <template x-for="(pid,i) in routeForm.poi_ids" :key="i">
                <span class="bg-brand-500/20 text-brand-400 px-2 py-1 rounded text-xs flex items-center gap-1">
                  <span x-text="(i+1)+'. '+(pois.find(p=>p.id===pid)?.title||'POI#'+pid)"></span>
                  <button type="button" @click="routeForm.poi_ids.splice(i,1)" class="hover:text-red-400">√ó</button>
                </span>
              </template>
            </div>
            <div class="max-h-48 overflow-y-auto border border-slate-700 rounded-lg">
              <template x-for="p in pois" :key="p.id">
                <div @click="toggleRoutePoi(p.id)" class="px-3 py-2 text-sm cursor-pointer hover:bg-slate-700/50 flex items-center gap-2 border-b border-slate-700/50"
                     :class="routeForm.poi_ids.includes(p.id)?'bg-brand-500/10 text-brand-400':'text-slate-300'">
                  <span class="w-4 h-4 rounded border flex items-center justify-center text-xs" :class="routeForm.poi_ids.includes(p.id)?'bg-brand-500 border-brand-500 text-black':'border-slate-500'">
                    <span x-show="routeForm.poi_ids.includes(p.id)" x-text="routeForm.poi_ids.indexOf(p.id)+1"></span>
                  </span>
                  <span x-text="p.title"></span>
                  <span class="text-slate-500 text-xs ml-auto" x-text="'#'+p.id"></span>
                </div>
              </template>
            </div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="px-6 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium" :disabled="loading">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" @click="showRouteForm=false" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>

    <!-- QUIZZES -->
    <div x-show="page==='quizzes'">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">–ö–≤–∏–∑—ã</h1>
        <button @click="showQuizForm=true;resetQuizForm()" class="px-4 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <div x-show="!showQuizForm" class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
        <table class="w-full"><thead class="bg-slate-900/50"><tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">ID</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–í–æ–ø—Ä–æ—Å</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">POI</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–û—Ç–≤–µ—Ç</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">XP</th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr></thead>
        <tbody class="divide-y divide-slate-700">
          <template x-for="q in quizzes" :key="q.id">
            <tr class="hover:bg-slate-700/30">
              <td class="px-4 py-3 text-sm text-slate-400" x-text="q.id"></td>
              <td class="px-4 py-3 text-sm max-w-xs truncate" x-text="q.question"></td>
              <td class="px-4 py-3 text-sm text-slate-400" x-text="pois.find(p=>p.id===q.poi_id)?.title||'POI#'+q.poi_id"></td>
              <td class="px-4 py-3 text-sm"><span class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs font-bold" x-text="q.correct_answer"></span></td>
              <td class="px-4 py-3 text-sm text-brand-400" x-text="q.xp_reward"></td>
              <td class="px-4 py-3 flex gap-2">
                <button @click="editQuiz(q)" class="text-brand-400 hover:text-brand-300 text-sm">–†–µ–¥.</button>
                <button @click="confirmDel('–£–¥–∞–ª–∏—Ç—å –∫–≤–∏–∑?',q.question.substring(0,40),()=>deleteQuiz(q.id))" class="text-red-400 hover:text-red-300 text-sm">–£–¥–∞–ª.</button>
              </td>
            </tr>
          </template>
        </tbody></table>
        <div x-show="quizzes.length===0" class="p-8 text-center text-slate-500">–ù–µ—Ç –∫–≤–∏–∑–æ–≤</div>
      </div>

      <!-- Quiz Form -->
      <div x-show="showQuizForm" class="bg-slate-800 border border-slate-700 rounded-xl p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-semibold" x-text="quizForm.id?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞ #'+quizForm.id:'–ù–æ–≤—ã–π –∫–≤–∏–∑'"></h2>
          <button @click="showQuizForm=false" class="text-slate-400 hover:text-white">‚úï</button>
        </div>
        <form @submit.prevent="saveQuiz()" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1">–¢–æ—á–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ *</label>
              <select class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model.number="quizForm.poi_id" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ POI...</option>
                <template x-for="p in pois" :key="p.id"><option :value="p.id" x-text="p.title"></option></template>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-sm font-medium text-slate-300 mb-1">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç *</label>
                <select class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model="quizForm.correct_answer">
                  <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                </select>
              </div>
              <div><label class="block text-sm font-medium text-slate-300 mb-1">XP –ù–∞–≥—Ä–∞–¥–∞</label><input type="number" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" x-model.number="quizForm.xp_reward"></div>
            </div>
          </div>
          <div><label class="block text-sm font-medium text-slate-300 mb-1">–í–æ–ø—Ä–æ—Å *</label><textarea class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 min-h-[60px]" x-model="quizForm.question" required></textarea></div>
          <div class="grid md:grid-cols-2 gap-4">
            <div><label class="block text-sm font-medium text-slate-300 mb-1" :class="quizForm.correct_answer==='A'&&'text-emerald-400'">–í–∞—Ä–∏–∞–Ω—Ç A *</label><input class="w-full bg-slate-900 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" :class="quizForm.correct_answer==='A'?'border-emerald-500':'border-slate-600'" x-model="quizForm.option_a" required></div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1" :class="quizForm.correct_answer==='B'&&'text-emerald-400'">–í–∞—Ä–∏–∞–Ω—Ç B *</label><input class="w-full bg-slate-900 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" :class="quizForm.correct_answer==='B'?'border-emerald-500':'border-slate-600'" x-model="quizForm.option_b" required></div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1" :class="quizForm.correct_answer==='C'&&'text-emerald-400'">–í–∞—Ä–∏–∞–Ω—Ç C *</label><input class="w-full bg-slate-900 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" :class="quizForm.correct_answer==='C'?'border-emerald-500':'border-slate-600'" x-model="quizForm.option_c" required></div>
            <div><label class="block text-sm font-medium text-slate-300 mb-1" :class="quizForm.correct_answer==='D'&&'text-emerald-400'">–í–∞—Ä–∏–∞–Ω—Ç D *</label><input class="w-full bg-slate-900 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500" :class="quizForm.correct_answer==='D'?'border-emerald-500':'border-slate-600'" x-model="quizForm.option_d" required></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="px-6 py-2 rounded-lg bg-brand-500 hover:bg-brand-600 text-black text-sm font-medium" :disabled="loading">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" @click="showQuizForm=false" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>


    <!-- ACHIEVEMENTS -->
    <div x-show="page==='achievements'">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h1>
        <span class="text-slate-400 text-sm" x-text="achievements.length+' –≤—Å–µ–≥–æ'"></span>
      </div>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="a in achievements" :key="a.id">
          <div class="bg-slate-800 border border-slate-700 rounded-xl p-5 hover:border-brand-500/50 transition-colors">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-brand-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                <span class="text-brand-400 text-lg">üèÜ</span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-sm" x-text="a.title"></div>
                <div class="text-xs text-slate-400 mt-0.5" x-text="a.description"></div>
                <div class="flex flex-wrap gap-2 mt-2">
                  <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="a.condition_type+' ‚â• '+a.condition_value"></span>
                  <span class="bg-brand-500/20 text-brand-400 px-2 py-0.5 rounded text-xs" x-text="'+'+a.xp_reward+' XP'"></span>
                  <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-400" x-text="'code: '+a.code"></span>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
      <div x-show="achievements.length===0" class="bg-slate-800 border border-slate-700 rounded-xl p-12 text-center text-slate-500">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ –±–∞–∑–µ</div>
    </div>

    <!-- COSMETICS -->
    <div x-show="page==='cosmetics'">
      <h1 class="text-2xl font-bold mb-6">–ö–æ—Å–º–µ—Ç–∏–∫–∞</h1>
      <!-- Tabs -->
      <div class="flex gap-1 mb-6 bg-slate-800 p-1 rounded-lg w-fit">
        <button @click="cosTab='titles'" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="cosTab==='titles'?'bg-brand-500 text-black':'text-slate-300 hover:text-white'">–¢–∏—Ç—É–ª—ã</button>
        <button @click="cosTab='frames'" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="cosTab==='frames'?'bg-brand-500 text-black':'text-slate-300 hover:text-white'">–†–∞–º–∫–∏</button>
        <button @click="cosTab='badges'" class="px-4 py-2 rounded-md text-sm font-medium transition-colors" :class="cosTab==='badges'?'bg-brand-500 text-black':'text-slate-300 hover:text-white'">–ë–µ–π–¥–∂–∏</button>
      </div>

      <!-- Titles -->
      <div x-show="cosTab==='titles'" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="t in cosTitles" :key="t.id">
          <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold text-sm" x-text="t.name"></span>
              <span class="px-2 py-0.5 rounded text-xs font-medium" :class="rarityClass(t.rarity)" x-text="t.rarity"></span>
            </div>
            <div class="text-xs text-slate-400 mb-3" x-text="t.description||'‚Äî'"></div>
            <div class="flex flex-wrap gap-1.5">
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="'code: '+t.code"></span>
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="t.unlock_type+(t.unlock_value?': '+t.unlock_value:'')"></span>
              <span x-show="t.is_default" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">default</span>
            </div>
          </div>
        </template>
        <div x-show="cosTitles.length===0" class="col-span-full bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500">–ù–µ—Ç —Ç–∏—Ç—É–ª–æ–≤</div>
      </div>

      <!-- Frames -->
      <div x-show="cosTab==='frames'" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="f in cosFrames" :key="f.id">
          <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold text-sm" x-text="f.name"></span>
              <span class="px-2 py-0.5 rounded text-xs font-medium" :class="rarityClass(f.rarity)" x-text="f.rarity"></span>
            </div>
            <div class="text-xs text-slate-400 mb-2" x-text="f.description||'‚Äî'"></div>
            <img x-show="f.image_url" :src="fullUrl(f.image_url)" class="w-16 h-16 rounded mb-2 object-cover">
            <div class="flex flex-wrap gap-1.5">
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="'code: '+f.code"></span>
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="f.unlock_type+(f.unlock_value?': '+f.unlock_value:'')"></span>
              <span x-show="f.css_class" class="bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded text-xs" x-text="'css: '+f.css_class"></span>
              <span x-show="f.is_default" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">default</span>
            </div>
          </div>
        </template>
        <div x-show="cosFrames.length===0" class="col-span-full bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500">–ù–µ—Ç —Ä–∞–º–æ–∫</div>
      </div>

      <!-- Badges -->
      <div x-show="cosTab==='badges'" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="b in cosBadges" :key="b.id">
          <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="text-lg" x-text="b.icon||'üéñÔ∏è'"></span>
                <span class="font-semibold text-sm" x-text="b.name"></span>
              </div>
              <span class="px-2 py-0.5 rounded text-xs font-medium" :class="rarityClass(b.rarity)" x-text="b.rarity"></span>
            </div>
            <div class="text-xs text-slate-400 mb-3" x-text="b.description||'‚Äî'"></div>
            <div class="flex flex-wrap gap-1.5">
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="'code: '+b.code"></span>
              <span class="bg-slate-700 px-2 py-0.5 rounded text-xs text-slate-300" x-text="b.unlock_type+(b.unlock_value?': '+b.unlock_value:'')"></span>
              <span x-show="b.is_default" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">default</span>
            </div>
          </div>
        </template>
        <div x-show="cosBadges.length===0" class="col-span-full bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500">–ù–µ—Ç –±–µ–π–¥–∂–µ–π</div>
      </div>
    </div>

    <!-- LEARNING -->
    <div x-show="page==='learning'">
      <h1 class="text-2xl font-bold mb-6">–û–±—É—á–µ–Ω–∏–µ</h1>
      <div x-show="!selectedModule">
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="m in modules" :key="m.id">
            <div @click="selectModule(m)" class="bg-slate-800 border border-slate-700 rounded-xl p-5 cursor-pointer hover:border-brand-500/50 transition-colors">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-brand-500/20 rounded-lg flex items-center justify-center"><span class="text-brand-400">üìö</span></div>
                <div><div class="font-semibold text-sm" x-text="m.title"></div><div class="text-xs text-slate-400" x-text="m.total_lessons+' —É—Ä–æ–∫–æ–≤'"></div></div>
              </div>
              <div class="text-xs text-slate-400 mb-3" x-text="m.description||''"></div>
              <div class="flex items-center gap-2">
                <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-brand-500 rounded-full" :style="'width:'+m.progress_pct+'%'"></div></div>
                <span class="text-xs text-slate-400" x-text="m.progress_pct+'%'"></span>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <span class="text-xs" :class="m.is_active?'text-emerald-400':'text-red-400'" x-text="m.is_active?'–ê–∫—Ç–∏–≤–µ–Ω':'–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'"></span>
                <span class="text-xs text-slate-500" x-text="'order: '+m.order"></span>
              </div>
            </div>
          </template>
        </div>
        <div x-show="modules.length===0" class="bg-slate-800 border border-slate-700 rounded-xl p-12 text-center text-slate-500">–ù–µ—Ç –º–æ–¥—É–ª–µ–π –æ–±—É—á–µ–Ω–∏—è</div>
      </div>

      <!-- Module detail with lessons -->
      <div x-show="selectedModule">
        <button @click="selectedModule=null" class="text-brand-400 hover:text-brand-300 text-sm mb-4 inline-flex items-center gap-1">‚Üê –ù–∞–∑–∞–¥ –∫ –º–æ–¥—É–ª—è–º</button>
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 mb-6">
          <h2 class="text-lg font-semibold" x-text="selectedModule?.title"></h2>
          <p class="text-sm text-slate-400 mt-1" x-text="selectedModule?.description"></p>
        </div>
        <h3 class="font-semibold mb-4">–£—Ä–æ–∫–∏</h3>
        <div class="space-y-3">
          <template x-for="l in lessons" :key="l.id">
            <div class="bg-slate-800 border border-slate-700 rounded-xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-sm" x-text="l.title"></div>
                  <div class="text-xs text-slate-400 mt-0.5" x-text="l.description||''"></div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="bg-brand-500/20 text-brand-400 px-2 py-0.5 rounded text-xs" x-text="'+'+l.xp_reward+' XP'"></span>
                  <span class="text-xs" :class="l.is_completed?'text-emerald-400':'text-slate-500'" x-text="l.is_completed?'‚úì –ü—Ä–æ–π–¥–µ–Ω':'–ù–µ –ø—Ä–æ–π–¥–µ–Ω'"></span>
                  <span class="text-xs text-slate-500" x-text="'–õ—É—á—à–∏–π: '+l.best_score+'%'"></span>
                  <span class="text-xs text-slate-500" x-text="'–ü–æ–ø—ã—Ç–æ–∫: '+l.attempts"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
        <div x-show="lessons.length===0" class="bg-slate-800 border border-slate-700 rounded-xl p-8 text-center text-slate-500 mt-4">–ù–µ—Ç —É—Ä–æ–∫–æ–≤ –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ</div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div x-show="page==='settings'">
      <h1 class="text-2xl font-bold mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <p class="text-slate-400 text-sm mb-6">–ê–ü–ò-—Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.</p>
      
      <div class="space-y-6">
        <!-- –ú–∞—à–∏–Ω–∞ –í—Ä–µ–º–µ–Ω–∏ -->
        <div class="bg-gradient-to-br from-violet-900/30 to-purple-900/20 border border-violet-500/30 rounded-xl p-5">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-violet-500/20 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-violet-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            </div>
            <div>
              <h3 class="font-bold text-white">–ú–∞—à–∏–Ω–∞ –í—Ä–µ–º–µ–Ω–∏</h3>
              <p class="text-xs text-slate-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ</p>
            </div>
          </div>
          <div class="space-y-4">
            <template x-for="s in siteSettings.filter(x => ['TIME_MACHINE_PROVIDER','TIME_MACHINE_MODE','GEMINIGEN_API_KEY','KIE_API_KEY'].includes(x.key))" :key="s.key">
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-medium text-sm text-white" x-text="settingLabel(s.key)"></div>
                    <div class="text-xs text-slate-500" x-text="settingDesc(s.key)"></div>
                  </div>
                  <span x-show="s.has_value" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">‚úì</span>
                </div>
                <div class="flex gap-2 mt-3">
                  <template x-if="isSelectSetting(s.key)">
                    <select x-model="settingsEditing[s.key]" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500">
                      <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                      <template x-for="opt in getSelectOptions(s.key)" :key="opt.value">
                        <option :value="opt.value" x-text="opt.label" :selected="s.value===opt.value"></option>
                      </template>
                    </select>
                  </template>
                  <template x-if="!isSelectSetting(s.key)">
                    <input :type="isSecret(s.key)?'password':'text'" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-violet-500" :placeholder="s.has_value?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ'" x-model="settingsEditing[s.key]">
                  </template>
                  <button @click="saveSetting(s.key, settingsEditing[s.key])" :disabled="!settingsEditing[s.key]" class="px-4 py-2 rounded-lg bg-violet-500 hover:bg-violet-600 text-white text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Telegram Bot -->
        <div class="bg-gradient-to-br from-blue-900/30 to-cyan-900/20 border border-blue-500/30 rounded-xl p-5">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            </div>
            <div>
              <h3 class="font-bold text-white">Telegram Bot</h3>
              <p class="text-xs text-slate-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</p>
            </div>
          </div>
          <div class="space-y-4">
            <template x-for="s in siteSettings.filter(x => ['TELEGRAM_BOT_TOKEN','TELEGRAM_BOT_USERNAME'].includes(x.key))" :key="s.key">
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-medium text-sm text-white" x-text="settingLabel(s.key)"></div>
                    <div class="text-xs text-slate-500" x-text="settingDesc(s.key)"></div>
                  </div>
                  <span x-show="s.has_value" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">‚úì</span>
                </div>
                <div class="flex gap-2 mt-3">
                  <input :type="isSecret(s.key)?'password':'text'" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" :placeholder="s.has_value?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ'" x-model="settingsEditing[s.key]">
                  <button @click="saveSetting(s.key, settingsEditing[s.key])" :disabled="!settingsEditing[s.key]" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- AI / LLM -->
        <div class="bg-gradient-to-br from-emerald-900/30 to-teal-900/20 border border-emerald-500/30 rounded-xl p-5">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            </div>
            <div>
              <h3 class="font-bold text-white">AI / LLM</h3>
              <p class="text-xs text-slate-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏</p>
            </div>
          </div>
          <div class="space-y-4">
            <template x-for="s in siteSettings.filter(x => ['AI_API_KEY','AI_API_BASE_URL','AI_MODEL'].includes(x.key))" :key="s.key">
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                  <div>
                    <div class="font-medium text-sm text-white" x-text="settingLabel(s.key)"></div>
                    <div class="text-xs text-slate-500" x-text="settingDesc(s.key)"></div>
                  </div>
                  <span x-show="s.has_value" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded text-xs">‚úì</span>
                </div>
                <div class="flex gap-2 mt-3">
                  <input :type="isSecret(s.key)?'password':'text'" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" :placeholder="s.has_value?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ'" x-model="settingsEditing[s.key]">
                  <button @click="saveSetting(s.key, settingsEditing[s.key])" :disabled="!settingsEditing[s.key]" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div x-show="siteSettings.length===0" class="bg-slate-800 border border-slate-700 rounded-xl p-12 text-center text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    </div><!-- max-w-7xl -->
  </main>
</div>
</template>


<script>
function app() {
  const _emptyPoi = () => ({ id:null, title:'', description:'', address:'', full_article:'', latitude:55.7558, longitude:37.6173, historic_image_url:'', modern_image_url:'', historic_images:[], modern_images:[], historic_panorama_url:'', modern_panorama_url:'', photos:[] });
  const _emptyRoute = () => ({ id:null, title:'', description:'', difficulty:'Easy', reward_xp:100, is_premium:false, poi_ids:[] });
  const _emptyQuiz = () => ({ id:null, poi_id:'', question:'', option_a:'', option_b:'', option_c:'', option_d:'', correct_answer:'A', xp_reward:10 });

  return {
    // Auth
    token: localStorage.getItem('token'),
    me: null,
    loginForm: { username: 'admin', password: '' },
    loginError: '',
    loading: false,

    // Navigation
    page: 'dashboard',
    sidebarItems: [
      { id:'dashboard', label:'–î–∞—à–±–æ—Ä–¥', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>' },
      { id:'users', label:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' },
      { id:'pois', label:'–¢–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' },
      { id:'routes', label:'–ú–∞—Ä—à—Ä—É—Ç—ã', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 20l-5.4-2.7A1 1 0 0 1 3 16.4V5.6a1 1 0 0 1 1.4-.9L9 7m0 13l6-3m-6 3V7m6 10l4.6 2.3a1 1 0 0 0 1.4-.9V7.6a1 1 0 0 0-.6-.9L15 4m0 13V4m0 0L9 7"/></svg>' },
      { id:'quizzes', label:'–ö–≤–∏–∑—ã', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' },
      { id:'achievements', label:'–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>' },
      { id:'cosmetics', label:'–ö–æ—Å–º–µ—Ç–∏–∫–∞', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>' },
      { id:'learning', label:'–û–±—É—á–µ–Ω–∏–µ', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>' },
      { id:'settings', label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>' },
    ],

    // Toasts & confirm
    toasts: [],
    confirmDialog: { show: false, title: '', msg: '', onOk: () => {} },

    // Data
    stats: [],
    leaderboard: [],
    users: [],
    userSearch: '',
    pois: [],
    routes: [],
    quizzes: [],
    achievements: [],
    cosTitles: [],
    cosFrames: [],
    cosBadges: [],
    cosTab: 'titles',
    modules: [],
    lessons: [],
    selectedModule: null,

    // Settings
    siteSettings: [],
    settingsEditing: {},  // key -> new value being typed

    // Forms
    showPoiForm: false,
    poiForm: _emptyPoi(),
    showRouteForm: false,
    routeForm: _emptyRoute(),
    showQuizForm: false,
    quizForm: _emptyQuiz(),

    // Computed
    get filteredUsers() {
      if (!this.userSearch) return this.users;
      const q = this.userSearch.toLowerCase();
      return this.users.filter(u => (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q) || (u.display_name||'').toLowerCase().includes(q));
    },

    // Init
    async init() {
      if (this.token) {
        try {
          this.me = await this.api('GET', '/api/v1/users/me');
          this.loadDashboard();
        } catch(e) {
          this.token = null;
          localStorage.removeItem('token');
        }
      }
    },

    // API helper
    async api(method, url, body) {
      const opts = { method, headers: {} };
      if (this.token) opts.headers['Authorization'] = 'Bearer ' + this.token;
      if (body && !(body instanceof FormData)) {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(body);
      } else if (body) {
        opts.body = body;
      }
      const res = await fetch(url, opts);
      if (res.status === 401 || res.status === 403) {
        this.token = null; localStorage.removeItem('token');
        throw new Error('Unauthorized');
      }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || 'Error ' + res.status);
      }
      if (res.status === 204) return null;
      return res.json();
    },

    // Toast
    toast(msg, type = 'success') {
      const id = Date.now();
      this.toasts.push({ id, msg, type });
    },

    confirmDel(title, msg, onOk) {
      this.confirmDialog = { show: true, title, msg, onOk };
    },

    fullUrl(u) {
      if (!u) return '';
      return u.startsWith('http') ? u : window.location.origin + u;
    },

    rarityClass(r) {
      const m = { common:'bg-slate-600 text-slate-200', rare:'bg-blue-500/20 text-blue-400', epic:'bg-purple-500/20 text-purple-400', legendary:'bg-brand-500/20 text-brand-400' };
      return m[r] || m.common;
    },

    // Auth
    async doLogin() {
      this.loginError = '';
      this.loading = true;
      try {
        const fd = new FormData();
        fd.append('username', this.loginForm.username);
        fd.append('password', this.loginForm.password);
        const res = await fetch('/api/v1/login/access-token', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        const data = await res.json();
        this.token = data.access_token;
        localStorage.setItem('token', this.token);
        this.me = await this.api('GET', '/api/v1/users/me');
        this.loadDashboard();
      } catch(e) {
        this.loginError = e.message;
      }
      this.loading = false;
    },

    logout() {
      this.token = null;
      localStorage.removeItem('token');
    },

    navigate(id) {
      this.page = id;
      this.showPoiForm = false;
      this.showRouteForm = false;
      this.showQuizForm = false;
      this.selectedModule = null;
      if (id === 'dashboard') this.loadDashboard();
      else if (id === 'users') this.loadUsers();
      else if (id === 'pois') this.loadPois();
      else if (id === 'routes') this.loadRoutes();
      else if (id === 'quizzes') this.loadQuizzes();
      else if (id === 'achievements') this.loadAchievements();
      else if (id === 'cosmetics') this.loadCosmetics();
      else if (id === 'learning') this.loadLearning();
      else if (id === 'settings') this.loadSettings();
    },

    // Loaders
    async loadDashboard() {
      try {
        const [users, pois, routes, quizzes, lb] = await Promise.all([
          this.api('GET', '/api/v1/users/?limit=1000'),
          this.api('GET', '/api/v1/pois/'),
          this.api('GET', '/api/v1/routes/'),
          this.api('GET', '/api/v1/quizzes/'),
          this.api('GET', '/api/v1/users/leaderboard?limit=10'),
        ]);
        this.users = users; this.pois = pois; this.routes = routes; this.quizzes = quizzes;
        this.leaderboard = lb;
        this.stats = [
          { label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', value: users.length, color: 'text-blue-400' },
          { label: '–¢–æ—á–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞', value: pois.length, color: 'text-emerald-400' },
          { label: '–ú–∞—Ä—à—Ä—É—Ç—ã', value: routes.length, color: 'text-brand-400' },
          { label: '–ö–≤–∏–∑—ã', value: quizzes.length, color: 'text-purple-400' },
        ];
      } catch(e) { console.error(e); }
    },

    async loadUsers() {
      try { this.users = await this.api('GET', '/api/v1/users/?limit=1000'); } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadPois() {
      try { this.pois = await this.api('GET', '/api/v1/pois/'); } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadRoutes() {
      try {
        this.routes = await this.api('GET', '/api/v1/routes/');
        if (!this.pois.length) this.pois = await this.api('GET', '/api/v1/pois/');
      } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadQuizzes() {
      try {
        this.quizzes = await this.api('GET', '/api/v1/quizzes/');
        if (!this.pois.length) this.pois = await this.api('GET', '/api/v1/pois/');
      } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadAchievements() {
      try { this.achievements = await this.api('GET', '/api/v1/achievements/'); } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadCosmetics() {
      try {
        const [t, f, b] = await Promise.all([
          this.api('GET', '/api/v1/cosmetics/titles'),
          this.api('GET', '/api/v1/cosmetics/frames'),
          this.api('GET', '/api/v1/cosmetics/badges'),
        ]);
        this.cosTitles = t; this.cosFrames = f; this.cosBadges = b;
      } catch(e) { this.toast(e.message, 'error'); }
    },

    async loadLearning() {
      try { this.modules = await this.api('GET', '/api/v1/learning/modules'); } catch(e) { this.toast(e.message, 'error'); }
    },

    async selectModule(m) {
      this.selectedModule = m;
      try { this.lessons = await this.api('GET', '/api/v1/learning/modules/' + m.id + '/lessons'); } catch(e) { this.toast(e.message, 'error'); }
    },

    // Settings
    async loadSettings() {
      try { this.siteSettings = await this.api('GET', '/api/v1/settings'); this.settingsEditing = {}; } catch(e) { this.toast(e.message, 'error'); }
    },
    async saveSetting(key, value) {
      try {
        await this.api('PUT', '/api/v1/settings', { key, value });
        this.toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        this.loadSettings();
      } catch(e) { this.toast(e.message, 'error'); }
    },
    settingLabel(key) {
      const labels = {
        'TELEGRAM_BOT_TOKEN': 'Bot Token',
        'TELEGRAM_BOT_USERNAME': 'Bot Username',
        'GEMINIGEN_API_KEY': 'GeminiGen API Key',
        'KIE_API_KEY': 'KIE API Key',
        'TIME_MACHINE_PROVIDER': '–ü—Ä–æ–≤–∞–π–¥–µ—Ä',
        'TIME_MACHINE_MODE': '–†–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
        'AI_API_KEY': 'API Key',
        'AI_API_BASE_URL': 'Base URL',
        'AI_MODEL': '–ú–æ–¥–µ–ª—å',
      };
      return labels[key] || key;
    },
    settingDesc(key) {
      const descs = {
        'TELEGRAM_BOT_TOKEN': '–¢–æ–∫–µ–Ω –æ—Ç @BotFather',
        'TELEGRAM_BOT_USERNAME': '–ò–º—è –±–æ—Ç–∞ –±–µ–∑ @',
        'GEMINIGEN_API_KEY': '–ö–ª—é—á API –¥–ª—è GeminiGen.AI',
        'KIE_API_KEY': '–ö–ª—é—á API –¥–ª—è KIE AI (nano-banana-pro)',
        'TIME_MACHINE_PROVIDER': '–°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
        'TIME_MACHINE_MODE': '–†–µ–∂–∏–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
        'AI_API_KEY': '–ö–ª—é—á –¥–ª—è LLM (OpenAI / —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)',
        'AI_API_BASE_URL': 'URL API (–ø—É—Å—Ç–æ –¥–ª—è OpenAI)',
        'AI_MODEL': 'gpt-4, gpt-3.5-turbo –∏ —Ç.–¥.',
      };
      return descs[key] || '';
    },
    isSecret(key) {
      return key.includes('TOKEN') || key.includes('KEY');
    },
    isSelectSetting(key) {
      return ['TIME_MACHINE_PROVIDER', 'TIME_MACHINE_MODE'].includes(key);
    },
    getSelectOptions(key) {
      if (key === 'TIME_MACHINE_PROVIDER') {
        return [
          { value: 'geminigen', label: 'GeminiGen.AI' },
          { value: 'kie', label: 'KIE AI (nano-banana-pro)' }
        ];
      }
      if (key === 'TIME_MACHINE_MODE') {
        return [
          { value: 'clothing_only', label: '–¢–æ–ª—å–∫–æ –æ–¥–µ–∂–¥–∞' },
          { value: 'full', label: '–ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è' },
          { value: 'full_vintage', label: '–ü–æ–ª–Ω–∞—è + –≤–∏–Ω—Ç–∞–∂' }
        ];
      }
      return [];
    },

    // File upload
    async uploadFile(event, cb) {
      const file = event.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('file', file);
      try {
        const data = await this.api('POST', '/api/v1/files/upload', fd);
        cb(data.url);
        this.toast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
      } catch(e) { this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error'); }
    },

    // Users
    async deleteUser(id) {
      try { await this.api('DELETE', '/api/v1/users/' + id); this.toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω'); this.loadUsers(); } catch(e) { this.toast(e.message, 'error'); }
    },

    // POIs

    resetPoiForm() { this.poiForm = _emptyPoi(); },
    editPoi(p) {
      this.poiForm = { ...p, historic_images: [...(p.historic_images||[])], modern_images: [...(p.modern_images||[])], photos: (p.photos||[]).map(ph=>({...ph})), address: p.address||'', full_article: p.full_article||'' };
      this.showPoiForm = true;
    },
    async savePoi() {
      this.loading = true;
      try {
        const payload = { ...this.poiForm };
        delete payload.id;
        if (!payload.historic_image_url) payload.historic_image_url = null;
        if (!payload.modern_image_url) payload.modern_image_url = null;
        if (!payload.historic_panorama_url) payload.historic_panorama_url = null;
        if (!payload.modern_panorama_url) payload.modern_panorama_url = null;
        if (!payload.address) payload.address = null;
        if (!payload.full_article) payload.full_article = null;
        // Clean photos: only include items with image_url and year
        payload.photos = (payload.photos||[]).filter(p => p.image_url && p.year).map(p => ({year:parseInt(p.year), image_url:p.image_url, description:p.description||null, source:p.source||null}));
        if (this.poiForm.id) {
          await this.api('PUT', '/api/v1/pois/' + this.poiForm.id, payload);
        } else {
          await this.api('POST', '/api/v1/pois/', payload);
        }
        this.toast('POI —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        this.showPoiForm = false;
        this.loadPois();
      } catch(e) { this.toast(e.message, 'error'); }
      this.loading = false;
    },
    async deletePoi(id) {
      try { await this.api('DELETE', '/api/v1/pois/' + id); this.toast('POI —É–¥–∞–ª—ë–Ω'); this.loadPois(); } catch(e) { this.toast(e.message, 'error'); }
    },

    // Routes

    resetRouteForm() { this.routeForm = _emptyRoute(); },
    editRoute(r) {
      this.routeForm = { id:r.id, title:r.title, description:r.description||'', difficulty:r.difficulty, reward_xp:r.reward_xp, is_premium:r.is_premium, poi_ids:(r.points||[]).map(p=>p.id) };
      this.showRouteForm = true;
    },
    toggleRoutePoi(id) {
      const idx = this.routeForm.poi_ids.indexOf(id);
      if (idx >= 0) this.routeForm.poi_ids.splice(idx, 1);
      else this.routeForm.poi_ids.push(id);
    },
    async saveRoute() {
      this.loading = true;
      try {
        const payload = { title:this.routeForm.title, description:this.routeForm.description, difficulty:this.routeForm.difficulty, reward_xp:this.routeForm.reward_xp, is_premium:this.routeForm.is_premium, poi_ids:this.routeForm.poi_ids };
        if (this.routeForm.id) {
          await this.api('PUT', '/api/v1/routes/' + this.routeForm.id, payload);
        } else {
          await this.api('POST', '/api/v1/routes/', payload);
        }
        this.toast('–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        this.showRouteForm = false;
        this.loadRoutes();
      } catch(e) { this.toast(e.message, 'error'); }
      this.loading = false;
    },
    async deleteRoute(id) {
      try { await this.api('DELETE', '/api/v1/routes/' + id); this.toast('–ú–∞—Ä—à—Ä—É—Ç —É–¥–∞–ª—ë–Ω'); this.loadRoutes(); } catch(e) { this.toast(e.message, 'error'); }
    },

    // Quizzes

    resetQuizForm() { this.quizForm = _emptyQuiz(); },
    editQuiz(q) {
      this.quizForm = { ...q };
      this.showQuizForm = true;
    },
    async saveQuiz() {
      this.loading = true;
      try {
        const payload = { poi_id:parseInt(this.quizForm.poi_id), question:this.quizForm.question, option_a:this.quizForm.option_a, option_b:this.quizForm.option_b, option_c:this.quizForm.option_c, option_d:this.quizForm.option_d, correct_answer:this.quizForm.correct_answer, xp_reward:this.quizForm.xp_reward };
        if (this.quizForm.id) {
          await this.api('PUT', '/api/v1/quizzes/' + this.quizForm.id, payload);
        } else {
          await this.api('POST', '/api/v1/quizzes/', payload);
        }
        this.toast('–ö–≤–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        this.showQuizForm = false;
        this.loadQuizzes();
      } catch(e) { this.toast(e.message, 'error'); }
      this.loading = false;
    },
    async deleteQuiz(id) {
      try { await this.api('DELETE', '/api/v1/quizzes/' + id); this.toast('–ö–≤–∏–∑ —É–¥–∞–ª—ë–Ω'); this.loadQuizzes(); } catch(e) { this.toast(e.message, 'error'); }
    },
  };
}


</script>
</body>
</html>
