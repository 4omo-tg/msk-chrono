{% extends "base.html" %}

{% block content %}
<h1 id="header">New Route</h1>

<form id="routeForm">
    <label>Title</label>
    <input type="text" id="title" required />

    <label>Description</label>
    <textarea id="description"></textarea>

    <label>Difficulty</label>
    <select id="difficulty">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
    </select>

    <label>Reward XP</label>
    <input type="number" id="reward_xp" step="0.1" value="100" />

    <label>Premium</label>
    <input type="checkbox" id="is_premium" />

    <!-- POI Selection -->
    <label style="margin-top:20px;">Points of Interest (Отметьте в нужном порядке)</label>
    <div id="poiList" style="max-height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>

    <button type="submit">Save</button>
</form>

<script>
    const id = window.location.pathname.split('/').pop();
    const isEdit = !isNaN(id);
    if (isEdit) {
        document.getElementById('header').innerText = 'Edit Route ' + id;
    }

    let selectedPOIs = []; // Track POI selection order

    async function loadPOIs(selectedIds = []) {
        const res = await api('/api/v1/pois/');
        const pois = await res.json();
        const container = document.getElementById('poiList');
        container.innerHTML = '';

        // Initialize selectedPOIs in edit mode with existing order
        if (selectedIds.length > 0) {
            selectedPOIs = [...selectedIds];
        }

        pois.forEach(poi => {
            const div = document.createElement('div');
            div.style.marginBottom = '8px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = poi.id;
            checkbox.className = 'poi-check';
            checkbox.style.width = 'auto';
            checkbox.style.marginRight = '8px';
            checkbox.checked = selectedIds.includes(poi.id);

            // Track selection order on change
            checkbox.addEventListener('change', function (e) {
                const poiId = parseInt(e.target.value);
                if (e.target.checked) {
                    // Add to selection order if not already there
                    if (!selectedPOIs.includes(poiId)) {
                        selectedPOIs.push(poiId);
                    }
                } else {
                    // Remove from selection order
                    selectedPOIs = selectedPOIs.filter(id => id !== poiId);
                }
                updateOrderHints();
            });

            const label = document.createElement('span');
            label.style.flex = '1';
            label.textContent = poi.title + ' (ID: ' + poi.id + ')';

            const orderHint = document.createElement('span');
            orderHint.className = 'order-hint';
            orderHint.style.fontSize = '0.9em';
            orderHint.style.marginLeft = '8px';
            orderHint.dataset.poiId = poi.id;

            div.appendChild(checkbox);
            div.appendChild(label);
            div.appendChild(orderHint);
            container.appendChild(div);
        });

        updateOrderHints();
    }

    function updateOrderHints() {
        document.querySelectorAll('.order-hint').forEach(hint => {
            const poiId = parseInt(hint.dataset.poiId);
            const index = selectedPOIs.indexOf(poiId);
            if (index >= 0) {
                hint.textContent = 'Порядок: ' + (index + 1);
                hint.style.fontWeight = 'bold';
                hint.style.color = '#28a745';
            } else {
                hint.textContent = '';
            }
        });
    }

    async function load() {
        if (isEdit) {
            const res = await api('/api/v1/routes/' + id);
            if (res.ok) {
                const data = await res.json();
                document.getElementById('title').value = data.title;
                document.getElementById('description').value = data.description;
                document.getElementById('difficulty').value = data.difficulty;
                document.getElementById('reward_xp').value = data.reward_xp;
                document.getElementById('is_premium').checked = data.is_premium;
                const selectedIds = data.points.map(p => p.id);
                await loadPOIs(selectedIds);
            }
        } else {
            await loadPOIs();
        }
    }

    document.addEventListener('DOMContentLoaded', load);

    document.getElementById('routeForm').onsubmit = async (e) => {
        e.preventDefault();

        // Use selectedPOIs array which maintains selection order
        const poiIds = selectedPOIs;

        const payload = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            difficulty: document.getElementById('difficulty').value,
            reward_xp: parseFloat(document.getElementById('reward_xp').value),
            is_premium: document.getElementById('is_premium').checked,
            poi_ids: poiIds
        };

        let res;
        if (isEdit) {
            res = await api('/api/v1/routes/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            res = await api('/api/v1/routes/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        if (res.ok) window.location.href = '/admin/routes';
        else alert('Error saving');
    };
</script>
{% endblock %}