# Ход выполнения работы
## Проект: Moscow Chrono — интерактивное PWA-приложение для исторических прогулок по Москве

---

## 1. Теоретико-аналитический этап

### 1.1 Анализ целевой аудитории и выбор концепции
На основе анализа социологических данных ВЦИОМ и НАФИ была выявлена корреляция между уровнем физической активности молодёжи (18–35 лет) и их вовлечённостью в культурную жизнь города. Исследования показали, что 67% респондентов готовы больше гулять при наличии интересного контента. Это послужило основой для концепции геймифицированных исторических маршрутов.

### 1.2 Применение Теории Самодетерминации (SDT)
Система мотивации приложения спроектирована с учётом трёх базовых потребностей SDT:
- **Автономия**: пользователь сам выбирает маршрут, темп прохождения, может пропускать квизы
- **Компетентность**: система уровней (Level 1–∞), прогресс-бары, награды за правильные ответы
- **Связь с другими**: система друзей, лидерборды, репутация

### 1.3 Выбор технологического стека
Требования к кроссплатформенности и офлайн-работе определили выбор архитектуры:

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Архитектура | **PWA** (Progressive Web App) | Единая кодовая база для iOS/Android/Desktop, установка без магазина |
| Frontend | **SvelteJS 5** + Vite 7 | Минимальный размер бандла, реактивность, компиляция в vanilla JS |
| Backend | **FastAPI** (Python 3.12) | Асинхронность, автодокументация OpenAPI, высокая производительность |
| База данных | **PostgreSQL** | Поддержка ARRAY типов для галерей, надёжность, расширяемость |
| Карты | **Leaflet.js** | Открытый код, лёгкость, офлайн-кэширование тайлов |
| Панорамы | **Photo Sphere Viewer** | WebGL-рендеринг 360°, мобильная оптимизация |

---

## 2. Контентно-исторический этап

### 2.1 Разработка библиотеки маршрутов
Создана структура данных маршрута в модели `Route`:
```python
class Route(Base):
    id = Column(Integer, primary_key=True)
    title = Column(String, nullable=False)       # "Замоскворечье: купеческая Москва"
    description = Column(String)                  # Подробное описание
    difficulty = Column(String, default="Easy")  # Easy/Medium/Hard
    reward_xp = Column(Float, default=100.0)     # Бонус за завершение
    points = relationship("PointOfInterest")     # Связанные POI в порядке обхода
```
Маршруты разработаны с учётом длительности 30–60 минут пешей прогулки (2–4 км) по историческим районам: Замоскворечье, Китай-город, Арбат, Патриаршие.

### 2.2 Сбор и обработка визуального материала
Для каждой точки интереса (Point of Interest) реализована поддержка галерей:
```python
class PointOfInterest(Base):
    title = Column(String, nullable=False)
    latitude = Column(Float, nullable=False)
    longitude = Column(Float, nullable=False)
    
    # Галерея исторических фото (архивы, до 10 изображений)
    historic_images = Column(ARRAY(String), default=[])
    # Галерея современных фото
    modern_images = Column(ARRAY(String), default=[])
    
    # Панорамы 360° для эффекта присутствия
    historic_panorama_url = Column(String, nullable=True)
    modern_panorama_url = Column(String, nullable=True)
```
Архивные фотографии получены из открытых источников (PastVu, Wikimedia Commons), обработаны для единообразия разрешения (1920×1280 px).

### 2.3 Создание интерактивного контента
Для каждой POI разработаны квизы с четырьмя вариантами ответа:
```python
class Quiz(Base):
    poi_id = Column(Integer, ForeignKey("point_of_interest.id"))
    question = Column(String)      # "В каком году был построен этот дом?"
    option_a = Column(String)      # "1812"
    option_b = Column(String)      # "1856"
    option_c = Column(String)      # "1891"
    option_d = Column(String)      # "1917"
    correct_answer = Column(String)  # "C"
    xp_reward = Column(Float, default=10.0)
```
Квизы интегрированы в игровой процесс — появляются после чек-ина в точке.

---

## 3. Программная реализация (Backend & Frontend)

### 3.1 Архитектура базы данных
Спроектирована реляционная схема PostgreSQL:

**Основные сущности:**
- `user` — профили с XP, уровнем, статистикой, Telegram-авторизацией
- `route` — маршруты с метаданными и наградами
- `point_of_interest` — геоточки с координатами и медиа
- `user_progress` — прогресс прохождения маршрутов
- `quiz` / `user_quiz_progress` — вопросы и ответы пользователей
- `achievement` / `user_achievement` — система достижений
- `friendship` / `friend_request` — социальный граф

**Геймификация (расширенная):**
- `season` / `user_season_progress` — сезонный контент
- `daily_challenge` — ежедневные задания
- `weekly_leaderboard` / `leaderboard_entry` — рейтинги
- `title` / `badge` / `profile_frame` — косметические награды

### 3.2 Серверная часть (API)
Реализован REST API на FastAPI со следующими эндпоинтами:

```
POST   /api/v1/auth/register          — регистрация
POST   /api/v1/auth/telegram/code     — авторизация через Telegram
GET    /api/v1/routes/                — список маршрутов
GET    /api/v1/routes/{id}            — детали маршрута с POI
POST   /api/v1/progress/              — начать маршрут
POST   /api/v1/progress/check-in      — чек-ин в точке (+50 XP)
GET    /api/v1/quizzes/poi/{poi_id}   — квизы для точки
POST   /api/v1/quizzes/{id}/submit    — отправка ответа
GET    /api/v1/achievements/          — список достижений
GET    /api/v1/users/me/              — профиль пользователя
```

Пример логики начисления XP и расчёта уровня:
```python
# Формула уровня: L = floor((-5 + sqrt(49 + 0.16 * XP)) / 2)
import math
new_level = math.floor((-5 + math.sqrt(49 + 0.16 * user.xp)) / 2)
user.level = max(1, new_level)
```

### 3.3 Клиентская часть
SvelteJS-приложение с компонентной архитектурой:

**Основные компоненты:**
- `Map.svelte` — интерактивная карта Leaflet с маркерами POI
- `PhotoGallery.svelte` — галерея «было/стало» с переключением эпох
- `PanoramaViewer.svelte` — просмотр 360° панорам через Photo Sphere Viewer
- `QuizModal.svelte` — модальное окно с квизом
- `OnboardingModal.svelte` — обучение новых пользователей

**Интеграция карт (Leaflet.js):**
```typescript
// Map.svelte — отрисовка маршрута с цветовой индикацией прогресса
const greenIcon = new L.Icon({...});  // Пройденные точки
const blueIcon = new L.Icon({...});   // Текущая цель
const redIcon = new L.Icon({...});    // Будущие точки

pois.forEach((poi, index) => {
    if (index < completedCount) icon = greenIcon;
    else if (index === completedCount) icon = blueIcon;
    // Рисуем линии маршрута с градиентом
});
```

### 3.4 PWA-функционал и офлайн-режим
Настроен `vite-plugin-pwa` с Workbox для кэширования:

```typescript
// vite.config.ts — стратегии кэширования
workbox: {
  runtimeCaching: [
    {
      // Тайлы карт — CacheFirst, 30 дней, до 500 тайлов
      urlPattern: /tile\.openstreetmap\.org/,
      handler: 'CacheFirst',
      options: { cacheName: 'map-tiles', maxEntries: 500 }
    },
    {
      // API маршрутов — NetworkFirst с fallback на кэш
      urlPattern: /\/api\/v1\/routes/,
      handler: 'NetworkFirst',
      options: { cacheName: 'api-routes' }
    },
    {
      // Изображения — CacheFirst, 30 дней
      urlPattern: /\.(png|jpg|jpeg|webp)$/,
      handler: 'CacheFirst',
      options: { cacheName: 'images' }
    }
  ]
}
```

**Манифест PWA:**
```json
{
  "name": "Moscow Chrono",
  "short_name": "MoscowChrono",
  "display": "standalone",
  "orientation": "portrait",
  "theme_color": "#171717"
}
```

---

## 4. Внедрение геймификации и UI/UX

### 4.1 Система XP и уровней
Реализована прогрессивная система опыта:
- **+50 XP** за каждый чек-ин в точке маршрута
- **+10 XP** за правильный ответ на квиз
- **+100 XP** бонус за завершение маршрута
- **Формула уровня**: `L = (-5 + √(49 + 0.16×XP)) / 2`

```svelte
<!-- Home.svelte — отображение прогресса -->
<div class="flex items-center gap-1.5">
    <span class="text-sm font-bold text-amber-500">Уровень {currentLevel}</span>
</div>
<div class="w-24 h-1.5 bg-neutral-700 rounded-full">
    <div class="bg-amber-500" style="width: {levelProgress}%"></div>
</div>
```

### 4.2 Цифровые награды (бейджи)
Система косметических наград:

```python
class Badge(Base):
    code = Column(String, unique=True)     # 'zamoskvorechye_explorer'
    name = Column(String)                   # 'Исследователь Замоскворечья'
    icon = Column(String)                   # 'Map' (Lucide icon)
    rarity = Column(String)                 # common/rare/epic/legendary
    unlock_type = Column(String)            # 'achievement', 'level', 'special'
```

**Примеры достижений:**
- «Первый шаг» — посетите первую точку интереса
- «Историк-любитель» — правильно ответьте на 10 квизов
- «Марафонец» — пройдите 5 маршрутов
- «Исследователь Замоскворечья» — завершите все маршруты района

### 4.3 Механика «Переключение эпох»
Компонент `PhotoGallery.svelte` реализует сравнение временных периодов:

```svelte
<!-- Табы переключения эпох -->
<div class="flex bg-neutral-900 rounded-lg p-1">
    <button on:click={() => activeTab = 'historic'}
            class:bg-neutral-700={activeTab === 'historic'}>
        <Clock size={14} /> Тогда
    </button>
    <button on:click={() => activeTab = 'modern'}
            class:bg-amber-500={activeTab === 'modern'}>
        <Camera size={14} /> Сейчас
    </button>
    <button on:click={() => activeTab = 'panorama'}>
        <Maximize2 size={14} /> Панорама 360°
    </button>
</div>
```

Пользователь может мгновенно переключаться между историческим и современным видом одного и того же места.

---

## 5. Тестирование и отладка

### 5.1 Полевое тестирование
Проведено тестирование на реальных маршрутах с устройствами:
- **Android**: Samsung Galaxy S21 (Chrome PWA)
- **iOS**: iPhone 13 (Safari, добавление на Home Screen)
- **Desktop**: Chrome, Firefox, Safari

**Проверенные сценарии:**
- Точность геолокации и чек-ина (радиус 50м)
- Работа в режиме офлайн (предзагруженные маршруты)
- Отображение карт без сети (кэшированные тайлы)
- Загрузка панорам на мобильном интернете

### 5.2 Оптимизация производительности

**Энергопотребление GPS:**
- Геолокация запрашивается только при нажатии «Я ЗДЕСЬ!»
- Не используется постоянное отслеживание в фоне

**Оптимизация изображений:**
- Lazy loading для галерей
- Кэширование на уровне Service Worker
- Сжатие панорам до WebP формата

**Производительность UI:**
- Svelte компилируется в оптимизированный vanilla JS
- TailwindCSS — purge неиспользуемых классов
- Code splitting для компонентов (динамический импорт Photo Sphere Viewer)

```typescript
// Динамическая загрузка тяжёлой библиотеки панорам
const { Viewer } = await import('@photo-sphere-viewer/core');
```

---

## Итоги

Реализовано полнофункциональное PWA-приложение **Moscow Chrono**, включающее:
- ✅ Серверное API на FastAPI с PostgreSQL
- ✅ Кроссплатформенный клиент на SvelteJS
- ✅ Интерактивные карты с маршрутами
- ✅ Галереи «было/стало» и 360° панорамы
- ✅ Систему геймификации (XP, уровни, достижения)
- ✅ Офлайн-режим через Service Workers
- ✅ Адаптивный дизайн для мобильных устройств
